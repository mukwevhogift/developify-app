/**
 * @file Firestore Security Rules for Developify
 * @version 5
 * @description This ruleset secures user profiles, property listings, KYC requests, and admin actions.
 * It enforces user ownership, role-based access, and status-based read permissions for properties.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Returns true if the requesting user is the owner of the document.
     * @param userId The UID of the document owner.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Returns true if the requesting user is a verified property owner.
     */
    function isVerifiedOwner() {
      return request.auth != null && request.auth.token.status == 'verified_owner';
    }

    /**
     * @description Returns true if the requesting user has the 'admin' role claim.
     */
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    /**
     * @description Returns true if the requesting user is authenticated.
     */
    function isAuthenticated() {
        return request.auth != null;
    }

    /**
     * @description Secures user profile data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Admins can read any user profile. Users can only read/update their own.
      allow get, update: if isOwner(userId) || isAdmin();
      // A user can create their own profile document.
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      // No one can list or delete users for now. Admins can do this via backend functions.
      allow list, delete: if false; 
    }

    /**
     * @description Secures KYC requests. Users can create, admins can read/update.
     * @path /kyc_requests/{requestId}
     */
    match /kyc_requests/{requestId} {
      // A user can create their own KYC request.
      allow create: if isOwner(request.resource.data.userId);
      // Admins can read, list, and update (to approve/reject) KYC requests.
      allow read, list, update: if isAdmin();
      allow delete: if false; // Deletes should be handled carefully, maybe archived instead.
    }

    /**
     * @description Secures property listings.
     * @path /properties/{propertyId}
     */
    match /properties/{propertyId} {
      // ANYONE can read a property that has been approved for public listing.
      allow get: if resource.data.status == 'approved' || isAdmin() || isOwner(resource.data.ownerId);
      // Authenticated users can list approved properties. Admins can list all properties.
      allow list: if isAuthenticated() || isAdmin();

      // CREATE: Only verified property owners can create new property listings.
      // The new property must belong to them and start as a 'draft'.
      allow create: if isVerifiedOwner() &&
                      isOwner(request.resource.data.ownerId) &&
                      request.resource.data.status == 'draft';

      // UPDATE: Can be performed by the owner or an admin under specific conditions.
      allow update: if 
        // Admin can update any property (e.g., to approve/reject).
        isAdmin() ||
        // Owner can update their own property under certain conditions.
        (
          isVerifiedOwner() &&
          isOwner(resource.data.ownerId) &&
          // Immutable fields check.
          request.resource.data.ownerId == resource.data.ownerId &&
          request.resource.data.createdAt == resource.data.createdAt &&
          (
            // Owner can update their draft.
            (resource.data.status == 'draft' && request.resource.data.status == 'draft') ||
            // Owner can submit a draft for review.
            (resource.data.status == 'draft' && request.resource.data.status == 'pending')
          )
        );

      // DELETE: Owners can only delete their own properties if they are in 'draft' status.
      allow delete: if isVerifiedOwner() && isOwner(resource.data.ownerId) && resource.data.status == 'draft';
    }

     /**
     * @description Secures chat messages within a property's chat room.
     * @path /chats/{propertyId}/messages/{messageId}
     */
    match /chats/{propertyId}/messages/{messageId} {
        // Only authenticated users can read messages.
        // For enhanced security, you could restrict this to users who have invested or the property owner.
        allow list, get: if isAuthenticated() || isAdmin();

        // Only authenticated users can send messages.
        // The senderId must match the user's UID.
        allow create: if isAuthenticated() && isOwner(request.resource.data.senderId);

        // Messages are immutable.
        allow update, delete: if false;
    }

    /**
     * @description Secures admin action logs.
     * @path /admin_actions/{actionId}
     */
    match /admin_actions/{actionId} {
      // Only admins can read the audit log.
      allow get, list: if isAdmin();
      // Writes are handled by backend functions.
      allow create, update, delete: if false;
    }

    /**
     * @description Placeholder for admin roles.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow read, write: if false; // No one has access yet
    }
  }
}
