/**
 * @file Firestore Security Rules for Developify
 * @version 3
 * @description This ruleset secures user profiles, property listings, and KYC requests.
 * It enforces user ownership, role-based access, and status-based read permissions for properties.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Returns true if the requesting user is the owner of the document.
     * @param userId The UID of the document owner.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Returns true if the requesting user is a verified property owner.
     *              This relies on a custom claim set by a backend function.
     */
    function isVerifiedOwner() {
      return request.auth != null && request.auth.token.role == 'property_owner';
    }

    /**
     * @description Placeholder for admin role check.
     */
    // function isAdmin() {
    //   return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    // }

    /**
     * @description Secures user profile data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get, update: if isOwner(userId); // || isAdmin()
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow list, delete: if false; // No one can list or delete users for now.
    }

    /**
     * @description Secures KYC requests. Users can only create their own.
     * @path /kyc_requests/{requestId}
     */
    match /kyc_requests/{requestId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, list, update, delete: if false; // Future: allow admin to read/update
    }

    /**
     * @description Secures property listings.
     * @path /properties/{propertyId}
     */
    match /properties/{propertyId} {
      // ANYONE can read a property that has been approved for public listing.
      allow get: if resource.data.status == 'approved';
      // ONLY authenticated users can list approved properties.
      allow list: if request.auth != null;

      // CREATE: Only verified property owners can create new property listings.
      // The new property must belong to them and start as a 'draft'.
      allow create: if isVerifiedOwner() &&
                      isOwner(request.resource.data.ownerId) &&
                      request.resource.data.status == 'draft';

      // UPDATE: Owners can only update their own properties.
      // Certain fields like ownerId and createdAt are immutable.
      // Status can only be changed from 'draft' to 'pending' by the owner.
      allow update: if isVerifiedOwner() &&
                      isOwner(resource.data.ownerId) &&
                      request.resource.data.ownerId == resource.data.ownerId &&
                      request.resource.data.createdAt == resource.data.createdAt &&
                      (
                        // Owner can update their draft.
                        (resource.data.status == 'draft' && request.resource.data.status == 'draft') ||
                        // Owner can submit a draft for review.
                        (resource.data.status == 'draft' && request.resource.data.status == 'pending')
                        // Future: Admin can approve/reject.
                        // || (isAdmin() && request.resource.data.status in ['approved', 'rejected'])
                      );

      // DELETE: Owners can only delete their own properties if they are in 'draft' status.
      allow delete: if isVerifiedOwner() && isOwner(resource.data.ownerId) && resource.data.status == 'draft';
    }

    /**
     * @description Placeholder for admin roles.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow read, write: if false; // No one has access yet
    }
  }
}